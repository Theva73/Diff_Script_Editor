<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>All-in-One Code Editor</title>
  
  <!-- CodeMirror CSS -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css"
  />

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #121212;
      color: #f5f5f5;
      overflow: hidden; /* Avoid extra scrolling in mobile */
    }
    #fileContainer {
      padding: 5px;
      background: #2a2a2a;
      border-bottom: 1px solid #333;
      text-align: center;
    }
    #fileContainer label {
      display: block;
      margin-bottom: 4px;
      font-size: 14px;
    }
    #fileContainer input {
      padding: 6px;
      font-size: 12px;
      width: 80%;
      max-width: 300px;
      border-radius: 16px;
      border: 1px solid #555;
      background: #3a3a3a;
      color: #f5f5f5;
    }
    .clear-button {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 16px;
      border: 1px solid #c0392b;
      background: #e74c3c;
      color: white;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
      transition: all 0.2s ease;
      min-width: 60px;
      width: 90%;
      max-width: 300px;
      text-align: center;
    }
    .main-container {
      display: flex;
      flex-direction: column;
      height: calc(100vh - 50px);
      overflow: hidden;
    }
    .tab-bar, .toolbar, .bottom-toolbar {
      display: flex;
      flex-wrap: nowrap;
      white-space: nowrap;
      overflow-x: auto;
      padding: 4px 5px;
      gap: 4px;
      background: #2a2a2a;
      border-bottom: 1px solid #333;
      font-size: 12px;
    }
    .tab-button, .tool-button {
      flex: 0 0 auto;
      padding: 6px 10px;
      min-width: 60px;
      font-size: 12px;
      border: 1px solid #555;
      background: #3a3a3a;
      color: #f5f5f5;
      border-radius: 20px;
      cursor: pointer;
      text-align: center;
    }
    .tab-button.active, .tool-button.primary {
      background: #0095ff;
      color: #fff;
      border-color: #0077cc;
    }
    .editor-container {
      flex: 1;
      background: #1a1a1a;
      overflow: auto;
      position: relative;
    }
    /* CodeMirror theme overrides */
    .cm-s-darkmode.CodeMirror {
      background: #1a1a1a !important;
      color: #f5f5f5 !important;
    }
    .cm-s-darkmode .CodeMirror-gutters {
      background: #2a2a2a !important;
      border-right: 1px solid #333 !important;
    }
    .cm-s-darkmode .CodeMirror-linenumber {
      color: #aaa !important;
      font-weight: bold;
    }
    .CodeMirror {
      height: 100% !important;
      font-size: 14px;
      line-height: 1.6;
    }
    .bottom-toolbar {
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid #333;
    }
    /* Preview frame hidden by default, shown when "Run" is clicked */
    #previewFrame {
      display: none;
      width: 100%;
      height: 100%;
      border: none;
    }
    /* AI Panel */
    #aiPanel {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #2a2a2a;
      padding: 10px;
      border-top: 2px solid #444;
      z-index: 100;
      color: #fff;
    }
    #aiPanel h4 {
      margin: 0 0 8px;
    }
    #aiResponse {
      max-height: 200px;
      overflow-y: auto;
      background: #333;
      padding: 10px;
      border-radius: 4px;
      font-size: 13px;
      white-space: pre-wrap;
      margin-bottom: 10px;
    }
    #closeAiPanel {
      background: #e74c3c;
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- File Input -->
  <div id="fileContainer">
    <label for="scriptFile">Load Script:</label>
    <input type="file" id="scriptFile" accept=".js,.txt,.html" />
    <button class="clear-button" id="clearBtn">Clear Editor</button>
  </div>

  <div class="main-container">
    <div class="tab-bar">
      <button class="tab-button active" id="codeTab">Code</button>
      <button class="tab-button" id="previewTab">Preview</button>
      <button class="tab-button" id="consoleTab">Console</button>
      <button class="tab-button" id="diffTab">Diff</button>
    </div>
    <div class="toolbar">
      <button class="tool-button" id="runBtn">Run</button>
      <button class="tool-button" id="analyzeBtn">Analyze</button>
      <button class="tool-button" id="findBtn">Find</button>
      <button class="tool-button" id="pasteBtn">Paste</button>
      <button class="tool-button" id="copyBtn">Copy</button>
      <button class="tool-button" id="formatBtn">Format</button>
      <button class="tool-button" id="preFixBtn">Fix</button>
      <button class="tool-button" id="saveBtn">Save</button>
      <button class="tool-button" id="lintBtn">Lint</button>
      <button class="tool-button" id="autoFixBtn">Auto Fix</button>
      <button class="tool-button primary" id="askAiBtn">AI Assist</button>
    </div>

    <!-- Editor container -->
    <div class="editor-container" id="editorContainer">
      <textarea id="code"></textarea>
      <!-- Hidden preview iframe for "Run" -->
      <iframe id="previewFrame"></iframe>
    </div>

    <div class="bottom-toolbar">
      <div class="nav-buttons">
        <button class="nav-button" id="navLeftBtn">&#8592;</button>
        <button class="nav-button" id="navRightBtn">&#8594;</button>
      </div>
      <button class="action-button" id="blockReplacerBtn">Block Replace</button>
      <button class="action-button" id="chatBtn">&#128172;</button>
      <button class="done-button" id="doneBtn">Done</button>
    </div>
  </div>

  <!-- AI Panel -->
  <div id="aiPanel">
    <h4>AI Assistant</h4>
    <div id="aiResponse">Response will appear here...</div>
    <button id="closeAiPanel">Close</button>
  </div>

  <!-- CodeMirror & Dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/searchcursor.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/search.min.js"></script>

  <!-- ESLint for browser (for Lint & Auto Fix) -->
  <script src="https://unpkg.com/eslint4b@8.31.0/dist/eslint4b.js"></script>
  <!-- Prettier for Format (and fallback auto-fix) -->
  <script src="https://unpkg.com/prettier@2.8.8/standalone.js"></script>
  <script src="https://unpkg.com/prettier@2.8.8/parser-babel.js"></script>

  <script>
    window.onload = function() {
      // Initialize CodeMirror
      const editor = CodeMirror.fromTextArea(document.getElementById("code"), {
        mode: "javascript",
        lineNumbers: true,
        lineWrapping: true,
        indentUnit: 2,
        tabSize: 2,
        autofocus: true,
        theme: "darkmode",
        styleActiveLine: true,
        matchBrackets: true,
        scrollbarStyle: "native"
      });

      // 1. File Import: Append file content to editor
      document.getElementById("scriptFile").addEventListener("change", function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
          const currentContent = editor.getValue();
          const newContent = currentContent
            ? currentContent + "\n" + evt.target.result
            : evt.target.result;
          editor.setValue(newContent);
        };
        reader.onerror = function(err) {
          console.error("Error reading file:", err);
        };
        reader.readAsText(file);
      });

      // 2. Clear Editor
      document.getElementById("clearBtn").addEventListener("click", () => {
        editor.setValue("");
      });

      // 3. Paste from Clipboard
      document.getElementById("pasteBtn").addEventListener("click", async () => {
        try {
          if (!navigator.clipboard) {
            alert("Clipboard API not available. Use your browser's paste shortcut.");
            return;
          }
          const text = await navigator.clipboard.readText();
          if (text) {
            const doc = editor.getDoc();
            const cursor = doc.getCursor();
            doc.replaceRange(text, cursor);
          }
        } catch (err) {
          console.error("Paste failed:", err);
          alert("Failed to paste. Check HTTPS and clipboard permissions.");
        }
      });

      // 4. Copy entire code to Clipboard
      document.getElementById("copyBtn").addEventListener("click", async () => {
        try {
          const code = editor.getValue();
          await navigator.clipboard.writeText(code);
          alert("Code copied to clipboard!");
        } catch (err) {
          alert("Failed to copy code. " + err.message);
        }
      });

      // 5. Format code with Prettier
      document.getElementById("formatBtn").addEventListener("click", () => {
        try {
          const code = editor.getValue();
          const formatted = prettier.format(code, {
            parser: "babel",
            plugins: prettierPlugins, // from <script src="...parser-babel.js">
            tabWidth: 2,
            singleQuote: false,
            semi: true
          });
          editor.setValue(formatted);
          alert("Formatted with Prettier!");
        } catch (err) {
          alert("Formatting failed: " + err.message);
        }
      });

      // 6. Lint code with ESLint
      document.getElementById("lintBtn").addEventListener("click", () => {
        const code = editor.getValue();
        const linter = new eslint4b.Linter();
        const config = {
          parserOptions: { ecmaVersion: 2021 },
          env: { browser: true },
          rules: {
            semi: ["error", "always"],
            "no-unused-vars": "warn"
          }
        };
        const messages = linter.verify(code, config);
        if (messages.length === 0) {
          alert("No lint errors found!");
        } else {
          let output = "Lint Errors:\n\n";
          messages.forEach(msg => {
            output += `Line ${msg.line}, Col ${msg.column}: [${msg.ruleId}] ${msg.message}\n`;
          });
          alert(output);
        }
      });

      // 7. Auto Fix (ESLint or fallback to Prettier)
      document.getElementById("autoFixBtn").addEventListener("click", () => {
        const code = editor.getValue();
        const linter = new eslint4b.Linter();
        const config = {
          parserOptions: { ecmaVersion: 2021 },
          env: { browser: true },
          rules: {
            semi: ["error", "always"],
            "no-unused-vars": "warn"
          },
          fix: true
        };
        if (typeof linter.verifyAndFix === "function") {
          const result = linter.verifyAndFix(code, config);
          if (result && result.fixed) {
            editor.setValue(result.output);
            alert("ESLint auto-fix applied!");
          } else {
            // If nothing was fixed, fallback or let user know
            alert("No ESLint fixes available. Trying Prettier instead...");
            const formatted = prettier.format(code, {
              parser: "babel",
              plugins: prettierPlugins
            });
            editor.setValue(formatted);
          }
        } else {
          // Fallback to Prettier
          alert("ESLint auto-fix not available. Using Prettier...");
          const formatted = prettier.format(code, {
            parser: "babel",
            plugins: prettierPlugins
          });
          editor.setValue(formatted);
        }
      });

      // 8. Run code in the preview iframe
      document.getElementById("runBtn").addEventListener("click", () => {
        const code = editor.getValue();
        const previewFrame = document.getElementById("previewFrame");
        // Show the iframe
        previewFrame.style.display = "block";
        // Write code into the iframe
        previewFrame.srcdoc = code;
        alert("Code is running in the preview iframe below!");
      });

      // 9. AI Assist
      const askAiBtn = document.getElementById("askAiBtn");
      const aiPanel = document.getElementById("aiPanel");
      const aiResponse = document.getElementById("aiResponse");
      const closeAiPanel = document.getElementById("closeAiPanel");

      askAiBtn.addEventListener("click", async () => {
        aiPanel.style.display = "block";
        aiResponse.textContent = "Thinking...";
        const codeValue = editor.getValue();
        const prompt = `Please review the following code and offer suggestions:\n\n${codeValue}`;
        try {
          const res = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer YOUR_OPENAI_API_KEY" // Replace with your API key
            },
            body: JSON.stringify({
              model: "gpt-3.5-turbo",
              messages: [
                { role: "system", content: "You are a helpful AI code assistant." },
                { role: "user", content: prompt }
              ],
              max_tokens: 500,
              temperature: 0.7
            })
          });
          const data = await res.json();
          if (data.error) {
            aiResponse.textContent = "API Error: " + JSON.stringify(data.error);
            return;
          }
          const answer = data.choices[0].message.content;
          aiResponse.textContent = answer;
        } catch (err) {
          console.error(err);
          aiResponse.textContent = "Error: " + err.message;
        }
      });

      closeAiPanel.addEventListener("click", () => {
        aiPanel.style.display = "none";
      });

      // 10. Placeholder or simple alerts for the other buttons
      document.getElementById("analyzeBtn").addEventListener("click", () => {
        alert("Analyze function not implemented yet.");
      });
      document.getElementById("findBtn").addEventListener("click", () => {
        alert("Search/Find panel not implemented yet.");
      });
      document.getElementById("saveBtn").addEventListener("click", () => {
        alert("Save function not implemented yet.");
      });
      document.getElementById("blockReplacerBtn").addEventListener("click", () => {
        alert("Block Replace function not implemented yet.");
      });
      document.getElementById("navLeftBtn").addEventListener("click", () => {
        alert("Navigate left function not implemented.");
      });
      document.getElementById("navRightBtn").addEventListener("click", () => {
        alert("Navigate right function not implemented.");
      });
      document.getElementById("chatBtn").addEventListener("click", () => {
        alert("Chat function not implemented.");
      });
      document.getElementById("doneBtn").addEventListener("click", () => {
        alert("Done function not implemented.");
      });
    };
  </script>
</body>
</html>