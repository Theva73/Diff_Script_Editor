<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mobile Code Editor with More Editor Space</title>
  <!-- CodeMirror CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
  <!-- Diff library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/diff/5.0.0/diff.min.js"></script>
  
  <style>
    /* General adjustments for more space */
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #121212;
      color: #f5f5f5;
      overflow: hidden;
    }
    /* Script Counter Panel (left side) remains unchanged */
    #scriptCountContainer {
      position: absolute;
      top: 50px;
      left: 0;
      width: 60px;
      background: #2a2a2a;
      border-right: 1px solid #333;
      text-align: center;
      padding: 8px 4px;
      color: #f5f5f5;
      font-weight: bold;
      z-index: 999;
      font-size: 12px;
    }
    @media (min-width: 481px) {
      .main-container {
        margin-left: 60px;
      }
    }
    @media (max-width: 480px) {
      #scriptCountContainer {
        position: fixed;
        top: 50px;
        left: 0;
      }
    }
    /* Reduce file input container height */
    #fileContainer {
      padding: 5px;
      background: #2a2a2a;
      border-bottom: 1px solid #333;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 10;
    }
    #fileContainer label {
      margin-bottom: 4px;
      color: #f5f5f5;
      font-size: 14px;
    }
    #fileContainer input {
      padding: 6px;
      font-size: 12px;
      width: 80%;
      max-width: 300px;
      border-radius: 16px;
      border: 1px solid #555;
      background: #3a3a3a;
      color: #f5f5f5;
    }
    /* Make main container taller by reducing top toolbar space */
    .main-container {
      display: flex;
      flex-direction: column;
      /* Remove extra reserved space: using 100vh minus fileContainer height (approx 50px) */
      height: calc(100vh - 50px);
      overflow: hidden;
      position: relative;
    }
    /* Reduce tab-bar and toolbar heights */
    .tab-bar, .toolbar {
      padding: 4px 5px;
      gap: 4px;
      background: #2a2a2a;
      border-bottom: 1px solid #333;
      z-index: 10;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      font-size: 12px;
    }
    .tab-button, .tool-button {
      padding: 6px 10px;
      min-width: 60px;
      font-size: 12px;
    }
    /* Editor container: flex-grow to fill remaining space */
    .editor-container {
      flex: 1;
      background: #1a1a1a;
      overflow: auto;
      position: relative;
      min-height: 0; /* Allow it to shrink as needed */
    }
    /* Custom CodeMirror dark theme */
    .cm-s-darkmode.CodeMirror {
      background: #1a1a1a !important;
      color: #f5f5f5 !important;
    }
    .cm-s-darkmode .CodeMirror-gutters {
      background: #2a2a2a !important;
      border-right: 1px solid #333 !important;
    }
    .cm-s-darkmode .CodeMirror-linenumber {
      color: #aaa !important;
      font-weight: bold;
    }
    .CodeMirror {
      height: 100% !important;
      font-size: 14px;
      line-height: 1.6;
    }
    /* Remaining styles (Search panel, Preview, Console, Diff, bottom toolbar, etc.) are mostly unchanged */
    .search-panel {
      display: none;
      flex-direction: column;
      gap: 8px;
      padding: 8px;
      background: #2a2a2a;
      border-bottom: 1px solid #333;
      z-index: 10;
    }
    .search-panel.show {
      display: flex;
    }
    .search-panel input {
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid #444;
      background: #3a3a3a;
      color: #f5f5f5;
      font-size: 14px;
    }
    .search-buttons {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    #searchResults {
      text-align: center;
      color: #ccc;
      font-size: 12px;
      padding: 3px;
      display: none;
    }
    .search-highlight {
      background-color: rgba(255, 255, 0, 0.3);
    }
    .search-highlight.current {
      background-color: rgba(255, 165, 0, 0.5);
      color: black;
    }
    #previewView {
      display: none;
      height: 100%;
      background: #ffffff;
    }
    #consoleView {
      display: none;
      height: 100%;
      background-color: #1a1a1a;
      overflow: auto;
      padding: 10px;
      font-family: monospace;
      color: #f5f5f5;
    }
    #diffView {
      display: none;
      padding: 8px;
      overflow-y: auto;
      font-family: monospace;
    }
    .bottom-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      background: #2a2a2a;
      border-top: 1px solid #333;
      z-index: 10;
      font-size: 12px;
    }
    .nav-buttons { display: flex; gap: 10px; }
    .nav-button, .action-button {
      background: transparent;
      border: none;
      color: #4a90e2;
      font-size: 20px;
      cursor: pointer;
      padding: 4px;
    }
    .done-button {
      color: #4a90e2;
      font-size: 16px;
      font-weight: bold;
      background: transparent;
      border: none;
      padding: 4px 8px;
      cursor: pointer;
    }
    /* Other styles (Issues Panel, Clear button, Block Replacer UI) remain the same */
    #issuesPanel {
      padding: 8px;
      background: #2d2d2d;
      border-bottom: 1px solid #444;
      max-height: 150px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .clear-button {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px 10px;
      border-radius: 16px;
      border: 1px solid #c0392b;
      background: #e74c3c;
      color: white;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
      transition: all 0.2s ease;
      min-width: 60px;
      width: 90%;
      max-width: 300px;
      text-align: center;
      margin: 10px auto;
    }
    /* Block Replacer UI */
    #blockReplacer {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #2a2a2a;
      border-top: 2px solid #444;
      padding: 10px;
      z-index: 100;
    }
    #blockReplacer textarea {
      width: 100%;
      height: 80px;
      background: #3a3a3a;
      color: #f5f5f5;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 6px;
      margin-bottom: 8px;
      font-family: monospace;
      font-size: 12px;
    }
    #blockReplacer button {
      padding: 8px 10px;
      margin-right: 6px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    #blockReplacer .primary {
      background: #0095ff;
      color: white;
    }
    #blockReplacer .secondary {
      background: #e74c3c;
      color: white;
    }
    @media (max-width: 480px) {
      .CodeMirror {
        font-size: 12px;
      }
      .tool-button, .tab-button {
        min-width: 60px;
        padding: 6px 10px;
      }
      .editor-container {
        min-height: 150px;
      }
    }
  </style>
</head>
<body>
  <!-- Script counter -->
  <div id="scriptCountContainer">
    Scripts:<br>
    <span id="scriptCount">0</span>
  </div>

  <!-- File input container -->
  <div id="fileContainer">
    <label for="scriptFile">Load Script:</label>
    <input type="file" id="scriptFile" accept=".js,.txt,.html">
    <button class="clear-button" id="clearBtn">üßπ Clear Editor</button>
  </div>

  <!-- Main editor container -->
  <div class="main-container">
    <div class="tab-bar">
      <button class="tab-button active" id="codeTab">üìù Code</button>
      <button class="tab-button" id="previewTab">üëÅÔ∏è Preview</button>
      <button class="tab-button" id="consoleTab">üíª Console</button>
      <button class="tab-button" id="diffTab">üìä Diff</button>
    </div>

    <div class="toolbar">
      <button class="tool-button primary" id="runBtn">‚ñ∂Ô∏è Run</button>
      <button class="tool-button" id="analyzeBtn">üîç Analyze</button>
      <button class="tool-button" id="findBtn">üîç Find</button>
      <button class="tool-button" id="pasteBtn">üìã Paste</button>
      <button class="tool-button" id="copyBtn">üìã Copy</button>
      <button class="tool-button" id="formatBtn">üîß Format</button>
      <button class="tool-button" id="preFixBtn">üõ†Ô∏è Fix</button>
      <button class="tool-button" id="saveBtn">üíæ Save</button>
      <button class="tool-button" id="lintBtn">üîé Lint</button>
      <button class="tool-button primary" id="autoFixBtn">‚ú® Auto Fix</button>
    </div>

    <!-- Search Panel -->
    <div class="search-panel" id="searchPanel">
      <input type="text" id="findInput" placeholder="Find...">
      <input type="text" id="replaceInput" placeholder="Replace with...">
      <div class="search-buttons">
        <button class="tool-button" id="findPrevBtn">‚¨ÜÔ∏è Prev</button>
        <button class="tool-button" id="findNextBtn">‚¨áÔ∏è Next</button>
        <button class="tool-button" id="replaceBtn">Replace</button>
        <button class="tool-button" id="replaceAllBtn">Replace All</button>
      </div>
      <div id="searchResults">
        <span id="currentMatch">0</span> of <span id="totalMatches">0</span> matches
      </div>
    </div>

    <!-- Editor container -->
    <div id="editor" class="editor-container">
      <textarea id="code"></textarea>
      <div id="line-scroll-overlay"><div id="line-scroll-content"></div></div>
    </div>
    
    <!-- Preview, Console and Diff Views -->
    <div id="previewView" class="editor-container">
      <iframe id="previewFrame" style="width:100%; height:100%; border:0;"></iframe>
    </div>
    <div id="consoleView" class="editor-container">
      <div id="consoleContent"></div>
    </div>
    <div id="diffView" class="editor-container">
      <div id="issuesPanel"></div>
      <div id="diffContent"></div>
    </div>
    
    <div class="bottom-toolbar">
      <div class="nav-buttons">
        <button class="nav-button">&#8592;</button>
        <button class="nav-button">&#8594;</button>
      </div>
      <button class="action-button" id="blockReplacerBtn">üìã</button>
      <button class="action-button">&#128172;</button>
      <button class="done-button">Done</button>
    </div>
  </div>

  <!-- Block Replacer UI -->
  <div id="blockReplacer">
    <h3 style="color:#f5f5f5; margin-top:0;">Block Replacer</h3>
    <textarea id="findBlock" placeholder="Enter block of code to find..."></textarea>
    <textarea id="replaceBlock" placeholder="Enter replacement block..."></textarea>
    <button class="primary" id="doBlockReplace">Replace Block</button>
    <button class="secondary" id="closeBlockReplacer">Close</button>
  </div>

  <!-- External scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/searchcursor.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/search.min.js"></script>
  <script src="https://unpkg.com/eslint4b@8.31.0/dist/eslint4b.js"></script>
  <script src="https://unpkg.com/prettier@2.8.8/standalone.js"></script>
  <script src="https://unpkg.com/prettier@2.8.8/parser-babel.js"></script>
  
  <script>
    // Initialize CodeMirror
    var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
      mode: "javascript",
      lineNumbers: true,
      lineWrapping: true,
      indentUnit: 2,
      tabSize: 2,
      autofocus: true,
      theme: "darkmode",
      styleActiveLine: true,
      matchBrackets: true,
      scrollbarStyle: "native"
    });

    // File input & script counter
    const scriptFileInput = document.getElementById("scriptFile");
    const scriptCountEl = document.getElementById("scriptCount");
    scriptFileInput.addEventListener("change", function(e) {
      scriptCountEl.textContent = e.target.files.length;
    });
    const clearBtn = document.getElementById("clearBtn");
    clearBtn.addEventListener("click", () => { editor.setValue(""); });

    /* --- Find & Replace --- */
    const findBtn = document.getElementById("findBtn");
    const searchPanel = document.getElementById("searchPanel");
    const findInput = document.getElementById("findInput");
    const replaceInput = document.getElementById("replaceInput");
    const findNextBtn = document.getElementById("findNextBtn");
    const findPrevBtn = document.getElementById("findPrevBtn");
    const replaceBtn = document.getElementById("replaceBtn");
    const replaceAllBtn = document.getElementById("replaceAllBtn");

    findBtn.addEventListener("click", () => {
      searchPanel.classList.toggle("show");
      if(searchPanel.classList.contains("show")) { findInput.focus(); }
    });
    findNextBtn.addEventListener("click", () => { editor.execCommand("findNext"); });
    findPrevBtn.addEventListener("click", () => { editor.execCommand("findPrev"); });
    replaceBtn.addEventListener("click", () => {
      const findText = findInput.value, replaceText = replaceInput.value;
      if(!findText) return;
      let cursor = editor.getDoc().getSearchCursor(findText, editor.getDoc().getCursor());
      if(cursor.findNext()){ cursor.replace(replaceText); }
    });
    replaceAllBtn.addEventListener("click", () => {
      const findText = findInput.value, replaceText = replaceInput.value;
      if(!findText) return;
      const doc = editor.getDoc();
      let cursor = doc.getSearchCursor(findText, {line:0, ch:0});
      editor.operation(() => { while(cursor.findNext()){ cursor.replace(replaceText); } });
    });

    /* --- Paste Integration --- */
    const pasteBtn = document.getElementById("pasteBtn");
    pasteBtn.addEventListener("click", async () => {
      try {
        const text = await navigator.clipboard.readText();
        if (text) { editor.getDoc().replaceRange(text, editor.getDoc().getCursor()); }
      } catch (err) { console.error("Paste failed:", err); }
    });

    /* --- ESLint Integration --- */
    const lintBtn = document.getElementById("lintBtn");
    lintBtn.addEventListener("click", () => {
      const code = editor.getValue();
      const linter = new eslint4b.Linter();
      const config = {
        parserOptions: { ecmaVersion: 2021 },
        env: { browser: true },
        rules: { semi: ["error", "always"], "no-unused-vars": "warn" }
      };
      const messages = linter.verify(code, config);
      for (let i = 0; i < editor.lineCount(); i++) {
        editor.removeLineClass(i, "background", "lint-error-line");
      }
      const issuesPanel = document.getElementById("issuesPanel");
      issuesPanel.innerHTML = "";
      if (messages.length === 0) {
        issuesPanel.innerHTML = "<p>No lint errors found.</p>";
      } else {
        const ul = document.createElement("ul");
        messages.forEach(msg => {
          const li = document.createElement("li");
          li.textContent = `Line ${msg.line}, Col ${msg.column}: [${msg.ruleId}] ${msg.message}`;
          ul.appendChild(li);
          if (msg.line) { editor.addLineClass(msg.line - 1, "background", "lint-error-line"); }
        });
        issuesPanel.appendChild(ul);
      }
    });

    /* --- Auto Fix Integration --- */
    const autoFixBtn = document.getElementById("autoFixBtn");
    autoFixBtn.addEventListener("click", () => {
      const code = editor.getValue();
      const linter = new eslint4b.Linter();
      const config = {
        parserOptions: { ecmaVersion: 2021 },
        env: { browser: true },
        rules: { semi: ["error", "always"], "no-unused-vars": "warn" },
        fix: true
      };
      if (typeof linter.verifyAndFix === 'function') {
        const result = linter.verifyAndFix(code, config);
        editor.setValue(result.output);
      } else {
        console.warn("ESLint auto-fix not available. Falling back to Prettier.");
        const fixedCode = prettier.format(code, { parser: "babel", plugins: prettierPlugins });
        editor.setValue(fixedCode);
      }
    });

    /* --- Block Replacer for Multi-line Replacement --- */
    const blockReplacerBtn = document.getElementById("blockReplacerBtn");
    const blockReplacer = document.getElementById("blockReplacer");
    const findBlock = document.getElementById("findBlock");
    const replaceBlock = document.getElementById("replaceBlock");
    const doBlockReplace = document.getElementById("doBlockReplace");
    const closeBlockReplacer = document.getElementById("closeBlockReplacer");
    blockReplacerBtn.addEventListener("click", () => { blockReplacer.style.display = "block"; findBlock.focus(); });
    closeBlockReplacer.addEventListener("click", () => { blockReplacer.style.display = "none"; });
    doBlockReplace.addEventListener("click", () => {
      const findText = findBlock.value, replaceText = replaceBlock.value;
      if(!findText) return;
      const escapedFind = findText.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
      const regex = new RegExp(escapedFind, "gm");
      editor.setValue(editor.getValue().replace(regex, replaceText));
      blockReplacer.style.display = "none";
    });
  </script>
</body>
</html>