  <script>
    // Initialize CodeMirror with a default code example (or leave empty)
    const editor = CodeMirror.fromTextArea(document.getElementById("code"), {
      mode: "javascript",
      lineNumbers: true,
      value: `// Original Script Example
function greet() {
  console.log("Hello, world!");
}
greet();`
    });

    // Load file content into the editor
    document.getElementById("scriptFile").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(ev) {
          editor.setValue(ev.target.result);
        }
        reader.readAsText(file);
      }
    });

    // Basic toolbar functions
    function runCode() {
      try {
        const code = editor.getValue();
        console.log("Running code:", code);
        alert("Code executed! (Check console.)");
      } catch (err) {
        alert("Error: " + err.message);
      }
    }
    function formatCode() { editor.setValue(editor.getValue()); alert("Code formatted!"); }
    function toggleSearch() { alert("Search feature not implemented in this demo."); }
    function copyCode() { navigator.clipboard.writeText(editor.getValue()); alert("Code copied!"); }
    function saveCode() { localStorage.setItem("savedCode", editor.getValue()); alert("Code saved!"); }

    // Pre‑Fix: Append fix snippet at the end of current code
    function preFixCode() {
      const fixSnippet = prompt("Paste your fix snippet:");
      if (fixSnippet !== null) {
        const currentCode = editor.getValue();
        const newCode = currentCode + "\n" + fixSnippet;
        editor.setValue(newCode);
        alert("Pre‑fix applied! Check your code before applying further fixes.");
      }
    }

    // Load Fixed Code: Use current code to compute a diff
    function loadFixedCode() {
      const fixedCode = prompt("If needed, paste the complete updated script (or leave blank to use current code):");
      const finalCode = fixedCode === null || fixedCode.trim() === "" ? editor.getValue() : fixedCode;
      applyFixes(finalCode);
    }

    // Auto‑Fix: Use ESLint auto‑fix via eslint4b
    function runAutoFix() {
      const originalCode = editor.getValue();
      const linter = new eslint4b.Linter();
      const config = {
        env: { browser: true, es6: true },
        rules: {
          "semi": ["error", "always"],
          "no-console": "error"
        },
        fix: true
      };
      const result = linter.verifyAndFix(originalCode, config);
      const fixedCode = result.fixed;
      const diff = Diff.diffLines(originalCode, fixedCode);
      let diffHtml = "";
      diff.forEach(part => {
        if (part.added) {
          diffHtml += `<span style="background-color: lightgreen;">${part.value}</span>`;
        } else if (part.removed) {
          diffHtml += `<span style="background-color: #fbb;">${part.value}</span>`;
        } else {
          diffHtml += part.value;
        }
      });
      document.getElementById("diffView").innerHTML = diffHtml;
      if (confirm("Auto‑fixes generated. Apply these fixes?")) {
        editor.setValue(fixedCode);
        alert("Auto‑fixes applied!");
      }
    }

    // Diff computation: Compare current code with provided fixedCode and show diff
    function applyFixes(fixedCode) {
      const originalCode = editor.getValue();
      const diff = Diff.diffLines(originalCode, fixedCode);
      let diffHtml = "";
      diff.forEach(part => {
        if (part.added) {
          diffHtml += `<span style="background-color: lightgreen;">${part.value}</span>`;
        } else if (part.removed) {
          diffHtml += `<span style="background-color: #fbb;">${part.value}</span>`;
        } else {
          diffHtml += part.value;
        }
      });
      document.getElementById("diffView").innerHTML = diffHtml;
      switchTab("diff");
    }

    // Switch between views: Editor, Preview, Diff
    function switchTab(tabName) {
      document.getElementById("editor").style.display = (tabName === "editor") ? "block" : "none";
      document.getElementById("diffView").style.display = (tabName === "diff") ? "block" : "none";
      document.getElementById("previewView").style.display = (tabName === "preview") ? "block" : "none";
      if (tabName === "preview") updatePreview();
    }

    // Update preview by loading current code into an iframe
    function updatePreview() {
      const code = editor.getValue();
      document.getElementById("previewFrame").srcdoc = code;
    }
  </script>
